// Simple custom chatbot logic (search-enabled)

const chatbotFAQ = [
  {
    question: /^(hi|hello|hey|greetings|good (morning|afternoon|evening))$/i,
    answer: 'Hello! How can I help you today?'
  },
  {
    question: /where.*located|location|address/i,
    answer: 'We are located here: <a href="https://share.google/UcSnI6Rc39oQleYNw" target="_blank">Google Maps</a>'
  },
  {
    question: /buy|rental|rent|purchase/i,
    answer: 'We have only Rental Available.'
  },
  {
    question: /tariff|rate|price|pricing|cost/i,
    answer: 'Please see our pricing/contact page: <a href="https://soukhyahomes.com/contact.html" target="_blank">Contact & Pricing</a>'
  }
];

let siteIndex = [];
let siteIndexLoaded = false;
let qaList = [];
let qaLoaded = false;

// Load static site index (generated by scripts/build_search_index.js)
fetch('/assets/search/site_index.json').then(r=>r.json()).then(data=>{ siteIndex = data; siteIndexLoaded=true; }).catch(()=>{ siteIndex = []; siteIndexLoaded=false; });

// Load Q&A dataset
fetch('/assets/search/qa.json').then(r=>r.json()).then(data=>{ qaList = data || []; qaLoaded = true; }).catch(()=>{ qaList = []; qaLoaded = false; });

function scoreMatch(query, text){
  const qTokens = (query||'').toLowerCase().match(/\w+/g) || [];
  const tTokens = (text||'').toLowerCase().match(/\w+/g) || [];
  if(qTokens.length===0 || tTokens.length===0) return 0;
  let matches = 0;
  const tSet = new Set(tTokens);
  for(const t of qTokens){ if(tSet.has(t)) matches++; }
  return matches / Math.max(1, tTokens.length);
}

function findBestQA(query){
  if(!qaLoaded || !qaList.length) return null;
  let best = {score:0, answer:null};
  for(const item of qaList){
    const s = scoreMatch(query, item.question);
    if(s > best.score){ best = {score: s, answer: item.answer, question: item.question}; }
  }
  // threshold tuned for short user queries; change if needed
  return best.score >= 0.35 ? best.answer : null;
}

function getChatbotAnswer(userInput) {
  const text = userInput.trim();

  // Pricing-related detection (always return the official PDF link)
  const pricingRx = /\b(tariff|rate|price|pricing|cost|deposit|monthly|terms|tariff|fees|charges)\b/i;
  const pricingLink = "/assets/img/SOUKHYA%20-%20terms%2C%20tariff%20%26%20facilities%20-%20JAN%202026.pdf";
  if(pricingRx.test(text)){
    // if we can produce a short answer from QA, include it as a quick summary
    const qaSummary = findBestQA(text);
    const pdfButtons = `<div style='margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;'><a href='${pricingLink}' target='_blank' rel='noopener noreferrer' style='display:inline-block;padding:8px 12px;background:#009688;color:#fff;border-radius:8px;text-decoration:none;font-weight:bold;'>Open Terms & Tariff (PDF)</a><a href='${pricingLink}' download style='display:inline-block;padding:8px 12px;background:#f3f4f6;color:#111;border-radius:8px;text-decoration:none;font-weight:600;'>Download</a></div>`;
    if(qaSummary){
      return `You can view the full terms & tariff here: <a href='${pricingLink}' target='_blank'>Terms & Tariff (PDF)</a>. Quick summary: ${qaSummary}${pdfButtons}`;
    }
    return `You can view the full terms & tariff here: <a href='${pricingLink}' target='_blank'>Terms & Tariff (PDF)</a>. Would you like a short summary?${pdfButtons}`;
  }

  for (const faq of chatbotFAQ) {
    if (faq.question.test(text)) {
      return faq.answer;
    }
  }
  // Try Q&A dataset
  const qaAnswer = findBestQA(text);
  if(qaAnswer) return qaAnswer;
  // No direct answer found â€” caller should fallback to site search
  return null; // signal that we should try site search
}

function excerptAround(content, token, radius=120){
  const idx = content.toLowerCase().indexOf(token.toLowerCase());
  if(idx === -1) return content.slice(0, Math.min(content.length, radius*2)) + (content.length > radius*2 ? '...' : '');
  const start = Math.max(0, idx - radius);
  const end = Math.min(content.length, idx + radius);
  return (start>0? '...':'') + content.slice(start, end).trim() + (end<content.length? '...':'');
}

function searchIndex(query, topK=3){
  if(!siteIndexLoaded || !siteIndex.length) return [];
  const tokens = (query||'').toLowerCase().match(/\w+/g) || [];
  if(tokens.length===0) return [];
  const results = siteIndex.map(doc=>{
    let count=0;
    for(const t of tokens){
      const occurrences = (doc.content.toLowerCase().split(t).length - 1) || 0;
      count += occurrences;
      // also boost for title matches
      if((doc.title || '').toLowerCase().includes(t)) count += 2;
    }
    const score = count / Math.max(1, doc.content.length);
    return {doc, score};
  }).filter(r=>r.score>0);
  results.sort((a,b)=>b.score - a.score);
  return results.slice(0, topK).map(r=>({url: r.doc.url, title: r.doc.title, excerpt: excerptAround(r.doc.content, tokens[0] || '', 120), score: r.score}));
}

let inactivityTimer = null;
function resetInactivityTimer() {
  if (inactivityTimer) clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    const messages = document.getElementById('chatbot-messages');
    if (!messages) return;
    messages.innerHTML += `<div style='margin-bottom:12px;'><b>Bot:</b> Do you have anything else we can help you with?<br><button id='chatbot-yes-btn' style='margin:8px 8px 0 0;padding:6px 18px;background:#009688;color:#fff;border:none;border-radius:8px;cursor:pointer;'>Yes</button><button id='chatbot-no-btn' style='margin:8px 0 0 0;padding:6px 18px;background:#bbb;color:#222;border:none;border-radius:8px;cursor:pointer;'>No</button></div>`;
    messages.scrollTop = messages.scrollHeight;
    document.getElementById('chatbot-yes-btn').onclick = function() {
      messages.innerHTML += `<div style='margin-bottom:12px;'><b>Bot:</b> You can reach us directly on WhatsApp: <a href='https://wa.me/919677227627' target='_blank'>Chat with Agent Now</a></div>`;
      messages.scrollTop = messages.scrollHeight;
    };
    document.getElementById('chatbot-no-btn').onclick = function() {
      messages.innerHTML += `<div style='margin-bottom:12px;'><b>Bot:</b> Thank you for reaching out to us. Wishing to meet you soon!</div>`;
      messages.scrollTop = messages.scrollHeight;
    };
  }, 120000); // 2 minutes
}

// Chatbot UI logic
function showChatbot() {
  if (document.getElementById('custom-chatbot')) return;
  const bot = document.createElement('div');
  bot.id = 'custom-chatbot';
  bot.style.position = 'fixed';
  bot.style.bottom = '32px';
  bot.style.left = '32px';
  bot.style.width = '340px';
  bot.style.background = '#fff';
  bot.style.borderRadius = '16px';
  bot.style.boxShadow = '0 4px 24px rgba(0,0,0,0.18)';
  bot.style.zIndex = '9999';
  bot.style.fontFamily = 'inherit';
  bot.innerHTML = `
  <div style="background:#009688;color:#fff;padding:16px 20px;border-radius:16px 16px 0 0;font-weight:bold;font-size:1.2em;">Soukhya Chatbot <span style='float:right;cursor:pointer;' id='chatbot-close-btn'>&times;</span></div>
    <div id="chatbot-messages" style="padding:16px;min-height:120px;max-height:180px;overflow-y:auto;font-size:1em;"></div>
    <form id="chatbot-form" style="display:flex;padding:12px 16px 16px 16px;gap:8px;">
      <input type="text" id="chatbot-input" placeholder="Type your question..." style="flex:1;padding:8px 12px;border-radius:8px;border:1px solid #ccc;">
      <button type="submit" style="background:#009688;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;">Send</button>
    </form>
  `;
  document.body.appendChild(bot);
  const messages = document.getElementById('chatbot-messages');
  const form = document.getElementById('chatbot-form');
  document.getElementById('chatbot-close-btn').onclick = function() {
    document.getElementById('custom-chatbot').remove();
    setTimeout(() => {
      if (!document.getElementById('chatbot-launch-btn')) addChatbotButton();
    }, 300);
  };
  form.onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('chatbot-input');
    const userText = input.value.trim();
    if (!userText) return;
    messages.innerHTML += `<div style='margin-bottom:8px;'><b>You:</b> ${userText}</div>`;

    const faqAnswer = getChatbotAnswer(userText);
    if(faqAnswer){
      messages.innerHTML += `<div style='margin-bottom:12px;'><b>Bot:</b> ${faqAnswer}</div>`;
    } else {
      // run site search
      const results = searchIndex(userText, 3);
      if(results && results.length){
        let html = `<div style='margin-bottom:12px;'><b>Bot:</b> I found these pages that might help:<br>`;
        for(const r of results){
          html += `<div style='margin-top:8px;padding:8px;border-radius:8px;background:#f7f7f7'><a href='${r.url}' target='_blank' style='font-weight:bold;color:#009688;'>${r.title}</a><div style='margin-top:6px;color:#333;'>${r.excerpt}</div></div>`;
        }
        html += `<div style='margin-top:8px;'><a href='/contact.html' target='_blank'>Contact us</a> if you need further details.</div></div>`;
        messages.innerHTML += html;
      } else {
        messages.innerHTML += `<div style='margin-bottom:12px;'><b>Bot:</b> For more information, please <a href="/contact.html" target="_blank">contact us</a>.</div>`;
      }
    }

    messages.scrollTop = messages.scrollHeight;
    input.value = '';
    resetInactivityTimer();
  };
  resetInactivityTimer();
}

// Floating button to open chatbot
function addChatbotButton() {
  if (document.getElementById('chatbot-launch-btn')) return;
  // Chatbot button only
  const btn = document.createElement('button');
  btn.id = 'chatbot-launch-btn';
  btn.innerText = 'Chatbot';
  btn.style.position = 'fixed';
  btn.style.bottom = '32px';
  btn.style.left = '32px';
  btn.style.background = '#009688';
  btn.style.color = '#fff';
  btn.style.border = 'none';
  btn.style.borderRadius = '50%';
  btn.style.width = '56px';
  btn.style.height = '56px';
  btn.style.fontSize = '0.85em';
  btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.18)';
  btn.style.zIndex = '9998';
  btn.style.cursor = 'pointer';
  btn.style.display = 'flex';
  btn.style.alignItems = 'center';
  btn.style.justifyContent = 'center';
  btn.style.textAlign = 'center';
  btn.style.padding = '0';
  btn.onclick = function() {
    btn.remove();
    showChatbot();
  };
  document.body.appendChild(btn);
}

window.addEventListener('DOMContentLoaded', addChatbotButton);
